name: Containers

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize]

permissions:
  contents: read
  id-token: write

jobs:
  prepare-matrix:
    name: Prepare Build Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v5
      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v46
      - run: sudo apt-get update && sudo apt-get install -y python3-yaml
      - name: Calculate build matrix
        id: set-matrix
        env:
          CHANGED_FILES: ${{ steps.changed-files.outputs.all_changed_files }}
        run: |
          python3 << 'EOF'
          import json
          import yaml
          import os
          
          needs_building = []
          changed_files = os.environ.get('CHANGED_FILES', '').split()
          with open('BUILD.yaml', 'r') as f:
              config = yaml.safe_load(f)

          containers = config.get('containers', [])
          for container in containers:
              project_dir = container.get('project_dir')
              # Handle root directory (.) - match all files
              if project_dir == '.':
                  if changed_files:
                      needs_building.append(container)
              elif any(f.startswith(project_dir + '/') or f == project_dir for f in changed_files):
                  needs_building.append(container)

          matrix = {'service': needs_building}
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"matrix={json.dumps(matrix)}\n")

          print(f"Filtered {len(needs_building)} containers out of {len(containers)}")
          EOF

  docker-build:
    name: Build ${{ matrix.service.name }}
    needs: prepare-matrix
    if: needs.prepare-matrix.outputs.matrix != '{"service":[]}'
    runs-on: athelas-rops-2c4g
    environment: ${{ github.event.ref == 'refs/heads/main' && 'gcp-artifacts-rw' || 'gcp-artifacts-ro' }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v5
      - name: Run Docker Build composite
        uses: ./.github/common-actions/docker-build
        with:
          job_name: ${{ matrix.service.name }}
          project_dir: ${{ matrix.service.project_dir }}
          dockerfile: ${{ matrix.service.dockerfile }}
          build_context: ${{ matrix.service.build_context || '.' }}
          image_target: ${{ matrix.service.image_target }}
          cache_scope: main
          gar_repository: ${{ matrix.service.name }}
          gar_registry: us-central1-docker.pkg.dev/athelas-rcm/norm
          publish_image: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          ssh_key: ${{ secrets.COMMURE_LIBRARY_SECRET }}

